-- +goose Up

-- Таблица category
CREATE TABLE "category" (
    id                              BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    title                           TEXT NOT NULL,
    created_at                      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at                      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    deleted_at                      TIMESTAMPTZ
);

INSERT INTO "category" (title) VALUES
    ('Продукты'),
    ('Транспорт'),
    ('Развлечения'),
    ('Другое');

-- Таблица transaction
CREATE TABLE "transaction" (
    id                              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    account_id                      UUID NOT NULL,
    is_income                       BOOLEAN NOT NULL,
    amount                          NUMERIC(18,2) NOT NULL,
    occurred_on                     DATE NOT NULL,
    category_id                     BIGINT NOT NULL REFERENCES "category"(id) ON DELETE RESTRICT,
    "description"                   TEXT NOT NULL,
    created_at                      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at                      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    deleted_at                      TIMESTAMPTZ
);

CREATE INDEX transaction_account_date_idx ON "transaction" (account_id, occurred_on) WHERE deleted_at IS NULL;

ALTER TABLE "transaction" ADD CONSTRAINT transaction_amount_income_chk CHECK ((amount > 0 AND is_income = TRUE) OR (amount < 0 AND is_income = FALSE) OR (amount = 0));

-- Таблица budget
CREATE TABLE "budget" (
    id                              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    account_id                      UUID NOT NULL,
    "period"                        DATE NOT NULL,
    category_id                     BIGINT NOT NULL REFERENCES "category"(id) ON DELETE RESTRICT,
    amount                          NUMERIC(18,2) NOT NULL,
    created_at                      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at                      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    deleted_at                      TIMESTAMPTZ
);

CREATE UNIQUE INDEX budget_account_period_category_uniq_idx ON "budget" (account_id, "period", category_id) WHERE deleted_at IS NULL;

-- +goose Down

DROP INDEX IF EXISTS budget_account_period_category_uniq_idx;

DROP TABLE IF EXISTS "budget";

ALTER TABLE "transaction" DROP CONSTRAINT IF EXISTS transaction_amount_income_chk;

DROP INDEX IF EXISTS transaction_account_date_idx;

DROP TABLE IF EXISTS "transaction";

DROP TABLE IF EXISTS "category";
